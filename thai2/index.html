<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (Infinite)</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d35400; /* Ê≥∞ÂºèÂ•∂Ëå∂Ëâ≤ */
            --bg: #f5f6fa;
            --card: #ffffff;
            --correct: #27ae60;
            --wrong: #c0392b;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 700px;
            margin: 20px;
            background: var(--card);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        header h1 {
            margin: 0;
            font-family: 'Prompt', sans-serif;
            font-size: 1.4rem;
        }

        .score-board {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Content Area */
        .content {
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Audio Button */
        .audio-wrapper {
            margin: 20px 0 40px 0;
            position: relative;
        }

        .play-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(211, 84, 0, 0.4);
            transition: transform 0.2s, background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .play-btn.playing {
            background: #e67e22;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(230, 126, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); }
        }

        .instruction {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-style: italic;
        }

        /* Options */
        .options-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            font-family: 'Prompt', sans-serif;
        }

        .option-card:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .option-tag {
            width: 30px;
            height: 30px;
            background: #ecf0f1;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        /* States */
        .option-card.correct {
            border-color: var(--correct);
            background-color: #eafaf1;
            color: var(--correct);
        }
        .option-card.correct .option-tag {
            background-color: var(--correct);
            color: white;
        }

        .option-card.wrong {
            border-color: var(--wrong);
            background-color: #fdeaea;
            color: var(--wrong);
        }
        .option-card.wrong .option-tag {
            background-color: var(--wrong);
            color: white;
        }

        /* Result & Feedback */
        .feedback-panel {
            margin-top: 20px;
            padding: 20px;
            background: #f1f2f6;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            display: none;
            animation: fadeIn 0.5s;
        }

        .script-text {
            font-family: 'Prompt', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #333;
        }

        .translation-text {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 15px;
        }

        .next-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            float: right;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>üáπüá≠ Thai Listening Infinite</h1>
            <div class="score-board">Correct: <span id="score">0</span> | Round: <span id="round">1</span></div>
        </header>

        <div class="content">
            <div class="instruction">‡∏ü‡∏±‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Listen and select the correct option)</div>
            
            <div class="audio-wrapper">
                <button class="play-btn" id="playBtn" onclick="playAudio()">
                    üîä
                </button>
            </div>

            <div class="options-list" id="optionsContainer">
                <!-- Options will be injected here -->
            </div>

            <div class="feedback-panel" id="feedbackPanel">
                <div class="script-text" id="scriptText"></div>
                <div class="translation-text" id="transText"></div>
                <button class="next-btn" onclick="nextRound()">‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ (Next) ‚ûú</button>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. Ë≥áÊñôÂ∫´ (Vocabulary Database)
        // ----------------------------------------------------
        const vocab = {
            locations: [
                { th: "‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô", en: "Airport", sound: "sa-nam-bin" },
                { th: "‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•", en: "Hospital", sound: "rong-pa-ya-ban" },
                { th: "‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", en: "Department Store", sound: "hang-sap-pa-sin-kha" },
                { th: "‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≥", en: "Floating Market", sound: "ta-lat-nam" },
                { th: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏£‡∏ñ‡πÑ‡∏ü", en: "Train Station", sound: "sa-tha-ni-rot-fai" },
                { th: "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°", en: "Hotel", sound: "rong-raem" },
                { th: "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£", en: "Restaurant", sound: "ran-a-han" }
            ],
            times: [
                { th: "‡πÅ‡∏õ‡∏î‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤", en: "8:00 AM", val: 8 },
                { th: "‡∏™‡∏¥‡∏ö‡πÇ‡∏°‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á", en: "10:30 AM", val: 10.5 },
                { th: "‡∏ö‡πà‡∏≤‡∏¢‡∏™‡∏≠‡∏á‡πÇ‡∏°‡∏á", en: "2:00 PM", val: 14 },
                { th: "‡∏´‡∏Å‡πÇ‡∏°‡∏á‡πÄ‡∏¢‡πá‡∏ô", en: "6:00 PM", val: 18 },
                { th: "‡∏™‡∏≠‡∏á‡∏ó‡∏∏‡πà‡∏°", en: "8:00 PM", val: 20 }
            ],
            prices: [
                { th: "‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡πâ‡∏≠‡∏¢‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö‡∏ö‡∏≤‡∏ó", num: 120 },
                { th: "‡∏™‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏¢‡∏´‡πâ‡∏≤‡∏™‡∏¥‡∏ö‡∏ö‡∏≤‡∏ó", num: 350 },
                { th: "‡∏´‡πâ‡∏≤‡∏£‡πâ‡∏≠‡∏¢‡∏ö‡∏≤‡∏ó", num: 500 },
                { th: "‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏û‡∏±‡∏ô‡∏™‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏¢‡∏ö‡∏≤‡∏ó", num: 1200 },
                { th: "‡πÅ‡∏õ‡∏î‡∏™‡∏¥‡∏ö‡∏ö‡∏≤‡∏ó", num: 80 }
            ],
            items: [
                { th: "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏Ç‡∏≤‡∏¢‡∏≤‡∏ß", en: "Long pants" },
                { th: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß", en: "White T-shirt" },
                { th: "‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏ö", en: "Sneakers" },
                { th: "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏õ‡πâ", en: "Backpack" },
                { th: "‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠", en: "Wristwatch" }
            ],
            actions: [
                { th: "‡∏•‡∏∑‡∏°‡πÑ‡∏ß‡πâ", en: "left/forgot" },
                { th: "‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤", en: "bought" },
                { th: "‡∏ó‡∏≥‡∏´‡∏≤‡∏¢", en: "lost" }
            ]
        };

        // ----------------------------------------------------
        // 2. È°åÁõÆÁîüÊàêÂô® (Generator Engine)
        // ----------------------------------------------------
        let currentQuestion = {};
        let score = 0;
        let round = 1;
        let isAnswered = false;

        // ÁîüÊàêÈö®Ê©üÊï¥Êï∏
        const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function generateQuestion() {
            // Èö®Ê©üÊ±∫ÂÆöÈ°åÂûãÔºö0=Âú∞Èªû, 1=ÂÉπÊ†º, 2=ÊôÇÈñì, 3=Áâ©ÂìÅ
            const type = randInt(0, 3);
            let q = {};

            if (type === 0) { // --- Âú∞ÈªûÈ°å (Taxi/Travel) ---
                const target = rand(vocab.locations);
                const distractor1 = rand(vocab.locations);
                const distractor2 = rand(vocab.locations);
                
                // Á¢∫‰øùÈÅ∏È†Ö‰∏çÈáçË§á
                if(target === distractor1) return generateQuestion();

                q = {
                    script: [
                        { role: 'A', text: "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö, ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà" + target.th + "‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö" },
                        { role: 'B', text: "‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞" },
                        { role: 'A', text: "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏Å‡πá‡∏û‡∏≠" }
                    ],
                    question: "‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?", // Man wants to go where?
                    correct: target.th,
                    options: [target.th, distractor1.th, distractor2.th, "‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô"],
                    translation: `A: Excuse me, please take me to ${target.en}.<br>B: OK. Highway?<br>A: No, normal road is fine.`
                };
            } 
            else if (type === 1) { // --- ÂÉπÊ†ºÈ°å (Shopping) ---
                const item = rand(vocab.items);
                const price = rand(vocab.prices);
                
                // Áî¢ÁîüÈåØË™§ÁöÑÂÉπÊ†ºÈÅ∏È†Ö
                let fakePrice1 = price.num + 100;
                let fakePrice2 = price.num > 100 ? price.num - 50 : price.num + 20;

                q = {
                    script: [
                        { role: 'B', text: "‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏ß‡∏¢‡∏à‡∏±‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞, " + item.th + "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞" },
                        { role: 'A', text: "‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà " + price.th + " ‡∏Ñ‡∏£‡∏±‡∏ö" },
                        { role: 'B', text: "‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡πà‡∏∞ ‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏≠‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡πà‡∏∞" }
                    ],
                    question: "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?", // How much is this item?
                    correct: price.num + " ‡∏ö‡∏≤‡∏ó",
                    options: [price.num + " ‡∏ö‡∏≤‡∏ó", fakePrice1 + " ‡∏ö‡∏≤‡∏ó", fakePrice2 + " ‡∏ö‡∏≤‡∏ó", "‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏¢"],
                    translation: `B: This ${item.en} is beautiful. How much?<br>A: It's on sale. Only ${price.num} Baht.<br>B: OK, I'll take one.`
                };
            }
            else if (type === 2) { // --- ÊôÇÈñìÈ°å (Appointment) ---
                const time = rand(vocab.times);
                const otherTime = rand(vocab.times);
                if(time === otherTime) return generateQuestion();

                q = {
                    script: [
                        { role: 'A', text: "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö" },
                        { role: 'B', text: "‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏ô‡∏±‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏Å‡πâ‡∏≤‡πÇ‡∏°‡∏á‡∏Ñ‡πà‡∏∞, ‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô " + time.th + " ‡∏Ñ‡πà‡∏∞" },
                        { role: 'A', text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö" }
                    ],
                    question: "‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏ß‡∏Å‡πÄ‡∏Ç‡∏≤‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á?", // What time is the meeting finally?
                    correct: time.th,
                    options: [time.th, "‡πÄ‡∏Å‡πâ‡∏≤‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤", otherTime.th, "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°"],
                    translation: `A: What time is our meeting tomorrow?<br>B: First it was 9 AM, but moved to ${time.en}.<br>A: Acknowledged. See you.`
                };
            }
            else { // --- Áâ©ÂìÅÈÅ∫Â§±È°å (Lost Item) ---
                const item = rand(vocab.items);
                const loc = rand(vocab.locations);
                const otherItem = rand(vocab.items);
                
                if(item === otherItem) return generateQuestion();

                q = {
                    script: [
                        { role: 'B', text: "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∞! ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏•‡∏∑‡∏°‡∏Ç‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞" },
                        { role: 'A', text: "‡πÄ‡∏≠‡πä‡∏∞... " + item.th + "‡∏Ç‡∏≠‡∏á‡∏ú‡∏°‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏´‡∏ô" },
                        { role: 'B', text: "‡∏ô‡∏µ‡πà‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏∑‡∏°‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡∏Ñ‡πà‡∏∞" },
                        { role: 'A', text: "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!" }
                    ],
                    question: "‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡∏•‡∏∑‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏ß‡πâ?", // What did the man leave behind?
                    correct: item.th,
                    options: [item.th, otherItem.th, "‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå", "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠"],
                    translation: `B: Sir! You seem to have forgotten something.<br>A: Eh... Where is my ${item.en}?<br>B: Here. You left it on the table.<br>A: Thank you so much!`
                };
            }

            // Ê¥óÁâåÈÅ∏È†Ö (Shuffle Options)
            q.options = q.options.sort(() => Math.random() - 0.5);
            return q;
        }

        // ----------------------------------------------------
        // 3. Ë™ûÈü≥ÂêàÊàêÁ≥ªÁµ± (Improved TTS)
        // ----------------------------------------------------
        const synth = window.speechSynthesis;
        let voices = [];

        // ËºâÂÖ•ËÅ≤Èü≥
        window.speechSynthesis.onvoiceschanged = () => {
            voices = synth.getVoices();
        };

        async function speakDialogue(script) {
            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playBtn').disabled = true;

            for (let line of script) {
                await speakLine(line.text, line.role);
                // Â¢ûÂä†Ë°åËàáË°å‰πãÈñìÁöÑËá™ÁÑ∂ÂÅúÈ†ì
                await new Promise(r => setTimeout(r, 600)); 
            }

            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playBtn').disabled = false;
        }

        function speakLine(text, role) {
            return new Promise((resolve) => {
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = 'th-TH';
                
                // ÂÑ™ÂÖàÈÅ∏ÊìáÊ≥∞Ë™ûËÅ≤Èü≥
                const thVoice = voices.find(v => v.lang.includes('th'));
                if (thVoice) utter.voice = thVoice;

                // Ë™øÊï¥ÂèÉÊï∏ËÆìËÅ≤Èü≥Êúâ‰∫õÂæÆËÆäÂåñ (Humanize)
                // ÊØèÊ¨°Ë™ûÈÄüÂæÆË™ø +/- 0.05
                const randomRate = (Math.random() * 0.1) - 0.05;

                if (role === 'A') {
                    // Áî∑ËÅ≤Ê®°Êì¨ (‰ΩéÈü≥)
                    utter.pitch = 0.8 + (Math.random() * 0.1); 
                    utter.rate = 0.9 + randomRate;
                } else {
                    // Â•≥ËÅ≤Ê®°Êì¨ (È´òÈü≥)
                    utter.pitch = 1.2 + (Math.random() * 0.1);
                    utter.rate = 1.05 + randomRate;
                }

                utter.onend = resolve;
                utter.onerror = resolve;
                synth.speak(utter);
            });
        }

        // ----------------------------------------------------
        // 4. ÈÅäÊà≤ÊéßÂà∂ÈÇèËºØ (Game Logic)
        // ----------------------------------------------------
        function initGame() {
            round = 1;
            score = 0;
            updateScore();
            loadRound();
        }

        function loadRound() {
            isAnswered = false;
            currentQuestion = generateQuestion();
            
            // UI Reset
            document.getElementById('feedbackPanel').style.display = 'none';
            document.getElementById('optionsContainer').innerHTML = '';
            document.getElementById('round').innerText = round;
            
            // Render Options
            const container = document.getElementById('optionsContainer');
            const letters = ['‡∏Å', '‡∏Ç', '‡∏Ñ', '‡∏á']; // Ê≥∞Êñá A, B, C, D

            // Âú®È°ØÁ§∫ÈÅ∏È†ÖÂâçÔºåÂÖàÊ∑ªÂä†È°åÁõÆÂïèÈ°å (Question Text)
            const qHeader = document.createElement('h3');
            qHeader.innerText = "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: " + currentQuestion.question;
            qHeader.style.textAlign = 'center';
            qHeader.style.marginBottom = '20px';
            container.appendChild(qHeader);

            currentQuestion.options.forEach((opt, idx) => {
                const div = document.createElement('div');
                div.className = 'option-card';
                div.innerHTML = `<div class="option-tag">${letters[idx]}</div> ${opt}`;
                div.onclick = () => checkAnswer(opt, div);
                container.appendChild(div);
            });

            // Auto play slightly delayed
            // setTimeout(() => playAudio(), 800);
        }

        function playAudio() {
            if (synth.speaking) synth.cancel();
            speakDialogue(currentQuestion.script);
        }

        function checkAnswer(selectedText, element) {
            if (isAnswered) return;
            isAnswered = true;

            const isCorrect = selectedText === currentQuestion.correct;
            
            // UI Feedback
            if (isCorrect) {
                element.classList.add('correct');
                score++;
                updateScore();
            } else {
                element.classList.add('wrong');
                // Highlight correct one
                const cards = document.querySelectorAll('.option-card');
                cards.forEach(card => {
                    if (card.innerText.includes(currentQuestion.correct)) {
                        card.classList.add('correct');
                    }
                });
            }

            // Show Script & Translation
            const fbPanel = document.getElementById('feedbackPanel');
            const scriptDiv = document.getElementById('scriptText');
            const transDiv = document.getElementById('transText');
            
            let htmlScript = "";
            currentQuestion.script.forEach(s => {
                const color = s.role === 'A' ? '#2980b9' : '#d35400';
                htmlScript += `<div style="color:${color}"><b>${s.role}:</b> ${s.text}</div>`;
            });

            scriptDiv.innerHTML = htmlScript;
            transDiv.innerHTML = "<b>‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• (Translation):</b><br>" + currentQuestion.translation;
            
            fbPanel.style.display = 'block';
        }

        function nextRound() {
            round++;
            loadRound();
        }

        function updateScore() {
            document.getElementById('score').innerText = score;
        }

        // Start
        window.onload = initGame;

    </script>
</body>
</html>
